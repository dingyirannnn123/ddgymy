<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dreamy Yuanman Wall - Lin Gaoyuan &amp; Wang Manyu</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#a855f7",
            "cerulean": "#0ea5e9",
            "lavender": "#e9d5ff",
            "sky-pastel": "#bae6fd",
            "background-light": "#fdfaff",
            "background-dark": "#1a1625",
            "kawaii-blue": "#E0F2FF",
            "kawaii-purple": "#F3E8FF",
          },
          fontFamily: {
            "display": ["Spline Sans"]
          },
          borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
        },
      },
    }
</script>
<style type="text/tailwindcss">
    body {
        font-family: 'Spline Sans', sans-serif;
        overflow-x: hidden;
    }
    .dreamy-bg {
        background: linear-gradient(135deg, #f5f3ff 0%, #e0f2ff 50%, #faf5ff 100%);
    }
    .dark .dreamy-bg {
        background: linear-gradient(135deg, #1a1625 0%, #162e3d 50%, #20162e 100%);
    }
    .floating-particle {
        position: fixed;
        background: white;
        border-radius: 50%;
        pointer-events: none;
        z-index: 1;
        filter: blur(1px);
    }
    .bubble-glow {
        box-shadow: 0 10px 25px -5px rgba(168, 85, 247, 0.15), 0 8px 10px -6px rgba(14, 165, 233, 0.1);
    }
    .kawaii-card {
        transition: transform 0.3s ease;
        position: relative; /* æ–°å¢ï¼šç¡®ä¿å¡ç‰‡å†…å…ƒç´ å±‚çº§æ­£å¸¸ */
        z-index: 10; /* æ–°å¢ï¼šé«˜äºèƒŒæ™¯ */
    }
    .kawaii-card:hover {
        transform: scale(1.03) rotate(1deg);
    }
    .masonry {
        column-count: 1;
        column-gap: 1.5rem;
    }
    @media (min-width: 768px) { .masonry { column-count: 2; } }
    @media (min-width: 1024px) { .masonry { column-count: 3; } }
    @media (min-width: 1280px) { .masonry { column-count: 4; } }
    .masonry-item {
        break-inside: avoid;
        margin-bottom: 1.5rem;
        position: relative; /* æ–°å¢ï¼šä¿®å¤å¸ƒå±€å±‚çº§ */
        z-index: 10;
    }
    .heart-btn {
        clip-path: path('M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z');
    }
    .custom-file-upload {
        @apply border-2 border-dashed border-purple-200 dark:border-purple-900/50 rounded-xl p-4 text-center cursor-pointer hover:bg-white/40 transition-colors flex flex-col items-center gap-2;
    }
    .input-kawaii {
        @apply w-full bg-white/50 dark:bg-black/20 border-2 border-purple-100 dark:border-purple-900/30 focus:border-purple-400 focus:ring-0 rounded-xl px-4 py-2 text-sm transition-all outline-none;
    }
    .gradient-text {
        @apply bg-clip-text text-transparent bg-gradient-to-r from-cerulean to-primary;
    }
    .delete-btn {
        @apply absolute top-2 right-2 w-8 h-8 rounded-full bg-red-500/10 hover:bg-red-500/20 flex items-center justify-center text-red-500 dark:text-red-400 transition-all opacity-0 group-hover:opacity-100 cursor-pointer;
    }
    /* æ–°å¢ï¼šå›¾ç‰‡å®¹å™¨æ ·å¼ï¼Œç¡®ä¿æ˜¾ç¤º */
    .wish-image-container {
        @apply mt-3 mb-2 w-full rounded-xl overflow-hidden border border-purple-100 dark:border-purple-900/20;
    }
    .wish-image {
        @apply w-full h-auto max-h-64 object-cover; /* æ”¹ç”¨autoé«˜åº¦ï¼Œé¿å…è£å‰ª */
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-700 dark:text-slate-200 min-h-screen">
<div class="fixed inset-0 dreamy-bg z-0 opacity-80"></div>
<div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
<div class="floating-particle w-2 h-2 top-20 left-[10%] opacity-40 bg-purple-200"></div>
<div class="floating-particle w-4 h-4 top-1/3 left-[20%] opacity-20 bg-blue-200"></div>
<div class="floating-particle w-3 h-3 top-1/2 left-[50%] opacity-30 bg-purple-100"></div>
<div class="floating-particle w-6 h-6 bottom-20 left-[15%] opacity-10 bg-blue-100"></div>
<div class="floating-particle w-5 h-5 top-1/4 right-[10%] opacity-25 bg-purple-200"></div>
<div class="floating-particle w-2 h-2 bottom-1/3 right-[30%] opacity-40 bg-blue-200"></div>
<div class="floating-particle w-4 h-4 top-10 right-[40%] opacity-20 bg-purple-100"></div>
</div>

<!-- Navigation Header -->
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-purple-100 dark:border-white/10 bg-white/70 dark:bg-background-dark/70 backdrop-blur-md px-6 py-3 sticky top-0 z-50">
    <div class="flex items-center gap-4">
        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white shadow-md">
            <span class="material-icons text-sm">auto_awesome</span>
        </div>
        <h2 class="text-lg font-bold text-primary dark:text-purple-300 hidden sm:block">Yuanman Wall</h2>
    </div>
    
    <nav class="hidden md:flex items-center gap-8">
        <a class="text-sm font-medium hover:text-primary transition-colors text-slate-600 dark:text-slate-300" href="index.html">åŸºæœ¬ä¿¡æ¯</a>
        <a class="text-sm font-medium hover:text-primary transition-colors text-slate-600 dark:text-slate-300" href="timeline.html">æˆå°±ä¸è£è€€</a>
        <a class="text-sm font-medium hover:text-primary transition-colors text-slate-600 dark:text-slate-300" href="journey.html">æ˜Ÿå…‰è·¯å¾„</a>
        <a class="text-sm font-medium hover:text-primary transition-colors text-slate-600 dark:text-slate-300" href="brands.html">å“ç‰Œä»£è¨€</a>
        <a class="text-sm font-medium hover:text-primary transition-colors text-slate-600 dark:text-slate-300" href="pets.html">èŒå® </a>
        <a class="text-sm font-semibold border-b-2 border-primary text-primary" href="å¯„è¯­åŒº.html">å¯„è¯­åŒº</a>
    </nav>

    <div class="flex items-center gap-4">
        <!-- Dark Mode Toggle -->
        <button class="w-10 h-10 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-800 backdrop-blur-md flex items-center justify-center border border-purple-100 dark:border-slate-700 transition-all" onclick="document.documentElement.classList.toggle('dark')">
            <span class="material-icons text-primary dark:text-purple-300 text-sm">light_mode</span>
        </button>
        
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="md:hidden text-primary p-2">
            <span class="material-symbols-outlined text-3xl">menu</span>
        </button>
    </div>
</header>

<header class="relative z-10 pt-16 pb-12 px-6 text-center">
<div class="inline-flex items-center gap-2 px-4 py-2 bg-white/60 dark:bg-white/5 backdrop-blur-md rounded-full mb-6 border border-purple-100 dark:border-white/10">
<span class="material-icons text-primary text-sm">auto_awesome</span>
<span class="text-sm font-semibold tracking-wider uppercase opacity-80 text-primary dark:text-purple-300">Yuanman Fan Community</span>
<span class="material-icons text-cerulean text-sm">star</span>
</div>
<h1 class="text-4xl md:text-6xl font-extrabold gradient-text mb-4 drop-shadow-sm">å¿ƒæ„¿å¢™</h1>
<p class="text-lg opacity-90 max-w-2xl mx-auto leading-relaxed">
    The best wishes for <span class="text-cerulean dark:text-sky-300 font-bold">Lin Gaoyuan</span> &amp; <span class="text-primary dark:text-purple-400 font-bold">Wang Manyu</span>. 
</p>
</header>

<main class="relative z-10 container mx-auto px-6 pb-32">
<div class="masonry">
    <!-- å¯„è¯­åˆ—è¡¨æ¸²æŸ“å®¹å™¨ -->
    <div id="wishList" class="w-full"></div>

    <!-- æäº¤è¡¨å•å¡ç‰‡ -->
    <div class="masonry-item">
    <div class="kawaii-card bg-white/95 dark:bg-slate-900/90 backdrop-blur-xl p-8 rounded-2xl bubble-glow relative border-4 border-purple-100 dark:border-purple-900/40 shadow-xl overflow-hidden">
        <div class="absolute -top-4 -right-4 w-20 h-20 bg-purple-200/30 opacity-50 rounded-full blur-xl"></div>
        <div class="absolute -bottom-4 -left-4 w-16 h-16 bg-blue-200/30 opacity-50 rounded-full blur-xl"></div>
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-purple-500/10 rounded-full flex items-center justify-center">
                <span class="material-icons text-primary">edit</span>
            </div>
            <h2 class="font-bold text-lg text-primary">Write</h2>
        </div>
        <form class="space-y-4" id="wishForm">
            <!-- æ˜µç§°è¾“å…¥æ¡† -->
            <div>
                <label class="block text-[10px] font-bold uppercase tracking-widest text-primary mb-1 ml-2">æ˜µç§°</label>
                <input id="nickname-input" class="input-kawaii" placeholder="e.g. å°æ±¤åœ†" type="text"/>
            </div>
            <!-- å¯„è¯­æ–‡æœ¬åŸŸ -->
            <div>
                <label class="block text-[10px] font-bold uppercase tracking-widest text-primary mb-1 ml-2">å¯„è¯­</label>
                <textarea id="message-input" class="input-kawaii resize-none" placeholder="Write something sweet..." rows="3"></textarea>
            </div>
            
            <!-- æ–°å¢ï¼šå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
            <div>
              <label class="block text-[10px] font-bold uppercase tracking-widest text-primary mb-1 ml-2">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
              <label class="custom-file-upload">
                <input 
                  type="file" 
                  id="imageUpload" 
                  accept="image/*" 
                  hidden
                />
                <span class="material-icons text-primary">add_photo_alternate</span>
                <span id="uploadText">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
              </label>
              <!-- é¢„è§ˆåŒº -->
              <div id="imagePreview" class="mt-3 hidden">
                <img id="previewImg" class="max-h-40 rounded-xl object-contain" />
              </div>
            </div>
            
            <!-- æäº¤æŒ‰é’® -->
            <div class="pt-2 flex justify-center">
              <button type="submit" class="group relative flex items-center justify-center w-20 h-20 transition-all duration-300 hover:scale-110 active:scale-95">
                <div class="absolute inset-0 bg-purple-200 blur-lg rounded-full group-hover:bg-purple-300 transition-colors"></div>
                <div class="w-full h-full bg-gradient-to-br from-purple-600 to-blue-500 heart-btn flex items-center justify-center rounded-full">
                  <span id="submitBtn" class="text-[18px] font-bold uppercase text-white">Submit</span>
                </div>
              </button>
            </div>
        </form>
    </div>
    </div>

    <!-- ç¤ºä¾‹å¡ç‰‡ï¼ˆä¿ç•™ï¼Œä¸å½±å“åŠŸèƒ½ï¼‰ -->
    <div class="masonry-item">
    <div class="kawaii-card bg-white/90 dark:bg-white/10 backdrop-blur-xl p-8 rounded-xl bubble-glow relative border-4 border-purple-50/50 dark:border-purple-900/20 shadow-sm group">
        <div class="absolute -top-3 -right-3 flex gap-1">
        <span class="material-icons text-primary text-xl drop-shadow-sm">favorite</span>
        <span class="material-icons text-cerulean text-xl drop-shadow-sm">star</span>
        </div>
        <div class="absolute -bottom-2 -left-2 bg-purple-50 w-8 h-8 rounded-full flex items-center justify-center border-2 border-white">
        <span class="text-[10px] font-bold text-primary">ğŸ’œ</span>
        </div>
        <div class="flex items-center gap-3 mb-4">
        <div class="relative">
            <img alt="Cute fan profile" class="w-12 h-12 rounded-full border-4 border-purple-100 shadow-sm object-cover" src="https://r2.ddgymy.dpdns.org/PicGo/çŸ¶æŠš2.webp"/>
            <div class="absolute -bottom-1 -right-1 text-xs">âœ¨</div>
        </div>
        <div>
            <p class="font-bold text-sm text-purple-600">jifu</p>
            <p class="text-[10px] opacity-60">2 hours ago</p>
        </div>
        </div>
        <p class="text-sm leading-relaxed text-gray-700"></p>
    </div>
    </div>

    <div class="masonry-item">
    <div class="kawaii-card bg-purple-50/60 dark:bg-primary/10 backdrop-blur-xl p-6 rounded-full rounded-tr-none bubble-glow relative border-2 border-purple-200/50 dark:border-purple-900/30 group">
        <div class="absolute -top-4 -left-2 text-2xl">ğŸ¦„</div>
        <div class="flex items-center gap-3 mb-4">
        <div class="relative">
            <img alt="Portrait of fan" class="w-12 h-12 rounded-full border-4 border-white shadow-sm object-cover" src="https://r2.ddgymy.dpdns.org/PicGo/è²‚è‰3.webp"/>
        </div>
        <div>
            <p class="font-bold text-sm text-cerulean dark:text-sky-300"></p>
            <p class="text-[10px] opacity-60">5 hours ago</p>
        </div>
        </div>
        <p class="text-sm leading-relaxed"></p>
    </div>
    </div>

    <div class="masonry-item">
    <div class="kawaii-card bg-white/70 dark:bg-white/5 backdrop-blur-xl p-10 rounded-full bubble-glow relative border-b-8 border-r-8 border-purple-100/50 group">
        <div class="absolute -top-6 left-1/2 -translate-x-1/2 flex gap-4">
        <div class="w-10 h-10 bg-purple-50/80 dark:bg-white/10 rounded-full border-4 border-purple-100/50"></div>
        <div class="w-10 h-10 bg-sky-50/80 dark:bg-white/10 rounded-full border-4 border-sky-100/50"></div>
        </div>
        <div class="flex flex-col items-center text-center">
        <div class="relative mb-3">
            <img alt="Fan avatar" class="w-14 h-14 rounded-full border-4 border-white shadow-md object-cover" src="https://r2.ddgymy.dpdns.org/PicGo/è²‚è‰2.webp"/>
        </div>
        <p class="font-bold text-sm mb-1 text-primary"></p>
        <p class="text-xs leading-relaxed"></p>
        <div class="mt-4 flex gap-1">
            <span class="material-icons text-primary text-xs">star</span>
            <span class="material-icons text-cerulean text-xs">favorite</span>
            <span class="material-icons text-primary text-xs">star</span>
        </div>
        </div>
    </div>
    </div>

    <div class="masonry-item">
    <div class="kawaii-card bg-gradient-to-br from-purple-50/80 to-sky-50/80 dark:from-purple-900/20 dark:to-blue-900/20 backdrop-blur-xl p-6 rounded-3xl bubble-glow relative overflow-hidden border-2 border-white/50 group">
        <div class="absolute top-0 right-0 w-16 h-16 bg-white/40 rounded-full -mr-8 -mt-8"></div>
        <div class="flex items-center gap-3 mb-4">
        <img alt="Artist fan" class="w-12 h-12 rounded-full border-4 border-white shadow-sm object-cover" src="https://r2.ddgymy.dpdns.org/PicGo/çŸ¶æŠš2.webp"/>
        <div>
            <p class="font-bold text-sm text-primary dark:text-purple-300"></p>
            <p class="text-[10px] opacity-60">Yesterday</p>
        </div>
        </div>
        <p class="text-sm"></p>
        <div class="mt-4 flex items-center gap-2">
        <div class="px-2 py-1 bg-white/60 dark:bg-black/40 rounded-full text-[10px] font-bold text-cerulean border border-cerulean/20">#LGY</div>
        <div class="px-2 py-1 bg-white/60 dark:bg-black/40 rounded-full text-[10px] font-bold text-primary border border-primary/20">#WMY</div>
        </div>
    </div>
    </div>

    <div class="masonry-item">
    <div class="kawaii-card bg-purple-50/40 dark:bg-white/5 backdrop-blur-md p-6 rounded-xl bubble-glow border-dashed border-2 border-primary/40 group">
        <div class="flex items-center gap-2 mb-2">
        <span class="material-icons text-primary text-lg">edit</span>
        <p class="text-[10px] font-bold tracking-tighter uppercase opacity-50">è¯·å†™ä¸‹ä½ çš„å¯„è¯­</p>
        </div>
        <p class="text-lg font-display italic text-primary/80 dark:text-purple-300"></p>
        <div class="mt-4 flex justify-end">
        <p class="text-xs font-bold text-slate-400"></p>
        </div>
    </div>
    </div>
</div>
</main>

<!-- æäº¤æˆåŠŸæç¤ºæ¡† -->
<div id="successToast" class="fixed top-8 right-8 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50">
  âœ… æäº¤æˆåŠŸï¼ä½ çš„ç•™è¨€å·²ç»ä¸Šå¢™å•¦ï½
</div>

<!-- åˆ é™¤ç¡®è®¤æç¤ºæ¡† -->
<div id="deleteConfirm" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-900 rounded-2xl p-8 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">ç¡®è®¤åˆ é™¤ï¼Ÿ</h3>
        <p class="text-slate-600 dark:text-slate-300 mb-6">åˆ é™¤åå¯„è¯­å°†æ— æ³•æ¢å¤ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ</p>
        <div class="flex gap-4">
            <button id="cancelDelete" class="flex-1 py-2 px-4 border border-slate-300 dark:border-slate-700 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">å–æ¶ˆ</button>
            <button id="confirmDelete" class="flex-1 py-2 px-4 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors">ç¡®è®¤åˆ é™¤</button>
        </div>
    </div>
</div>

<!-- æ‚¬æµ®æŒ‰é’® -->
<div class="fixed bottom-8 right-8 z-50 flex flex-col items-center pointer-events-none">
<button class="pointer-events-auto group relative flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95">
<div class="w-20 h-20 bg-gradient-to-tr from-primary to-cerulean shadow-2xl heart-btn flex flex-col items-center justify-center text-white p-4">
<span class="material-icons text-3xl group-hover:animate-bounce">pencil</span>
<span class="text-[8px] font-bold uppercase tracking-widest text-center mt-1">Write</span>
</div>
<div class="absolute inset-0 bg-primary/40 blur-2xl -z-10 rounded-full scale-75 group-hover:scale-110 transition-transform"></div>
</button>
</div>

<div class="fixed bottom-4 left-4 z-20 pointer-events-none opacity-50">
<div class="flex gap-4 items-end">
<span class="text-4xl">ğŸ’œ</span>
<span class="text-2xl">ğŸ§Š</span>
</div>
</div>

<div class="fixed bottom-4 right-4 z-20 pointer-events-none opacity-50 md:right-32">
<div class="flex gap-4 items-end">
<span class="text-2xl">â­</span>
<span class="text-4xl">ğŸŒ¸</span>
</div>
</div>

<!-- Mobile Menu Overlay -->
<div id="mobile-menu" class="fixed inset-0 bg-white/95 dark:bg-background-dark/95 backdrop-blur-xl z-[100] hidden flex-col items-center justify-center gap-8 transition-all duration-300 opacity-0 pointer-events-none">
    <button id="close-menu-btn" class="absolute top-6 right-6 text-slate-500 hover:text-primary">
        <span class="material-symbols-outlined text-4xl">close</span>
    </button>
    <a class="text-slate-600 dark:text-slate-300 hover:text-primary text-2xl font-medium transition-colors" href="index.html">åŸºæœ¬ä¿¡æ¯</a>
    <a class="text-slate-600 dark:text-slate-300 hover:text-primary text-2xl font-medium transition-colors" href="timeline.html">æˆå°±ä¸è£èª‰</a>
    <a class="text-slate-600 dark:text-slate-300 hover:text-primary text-2xl font-medium transition-colors" href="journey.html">æ˜Ÿå…‰è·¯å¾„</a>
    <a class="text-slate-600 dark:text-slate-300 hover:text-primary text-2xl font-medium transition-colors" href="brands.html">å“ç‰Œä»£è¨€</a>
    <a class="text-slate-600 dark:text-slate-300 hover:text-primary text-2xl font-medium transition-colors" href="pets.html">èŒå® </a>
    <a class="text-primary text-2xl font-semibold border-b-2 border-primary" href="å¯„è¯­åŒº.html">å¯„è¯­åŒº</a>
</div>

<!-- ç§»åŠ¨ç«¯èœå•é€»è¾‘ -->
<script>
    const mobileBtn = document.getElementById('mobile-menu-btn');
    const closeBtn = document.getElementById('close-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');

    function toggleMenu() {
        const isHidden = mobileMenu.classList.contains('hidden');
        if (isHidden) {
            mobileMenu.classList.remove('hidden');
            setTimeout(() => {
                mobileMenu.classList.remove('opacity-0', 'pointer-events-none');
            }, 10);
        } else {
            mobileMenu.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                mobileMenu.classList.add('hidden');
            }, 300);
        }
    }

    if(mobileBtn) mobileBtn.addEventListener('click', toggleMenu);
    if(closeBtn) closeBtn.addEventListener('click', toggleMenu);
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===================== ä½ çš„ Supabase é…ç½® =====================
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vZ3N3eG5lZmVybHV3bXNsamNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MjU1NTIsImV4cCI6MjA4NjAwMTU1Mn0.9HlTsGe3FGp7SQIFtFgzg0cdNbKRWSawE0N58ggPBWI";
const SUPABASE_URL = "https://oogswxneferluwmsljca.supabase.co";
// ===================== é…ç½®ç»“æŸ =====================

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== éšæœºå¡ç‰‡æ ·å¼+éšæœºå¤´åƒ ==========
function getRandomCardStyle() {
  const avatarList = [
    "https://r2.ddgymy.dpdns.org/PicGo/çŸ¶æŠš2.webp",
    "https://r2.ddgymy.dpdns.org/PicGo/è²‚è‰3.webp",
    "https://r2.ddgymy.dpdns.org/PicGo/è²‚è‰2.webp"
  ];
  const randomAvatar = avatarList[Math.floor(Math.random() * avatarList.length)];

  const styleList = [
    {
      containerClass: 'bg-white/90 dark:bg-white/10 backdrop-blur-xl p-6 rounded-3xl bubble-glow relative',
      decorator: `<div class="absolute -top-3 -right-3"><span class="material-icons text-primary text-xl drop-shadow-sm">star</span></div>`,
      tag: '',
      avatar: randomAvatar
    },
    {
      containerClass: 'bg-purple-50/70 dark:bg-primary/10 backdrop-blur-xl p-8 rounded-full bubble-glow relative',
      decorator: `<div class="absolute top-4 right-4 flex gap-1"><span class="text-purple-400">â˜…</span><span class="text-blue-400">â™¥</span><span class="text-purple-400">â˜…</span></div>`,
      tag: '',
      avatar: randomAvatar
    },
    {
      containerClass: 'bg-white/80 dark:bg-white/5 backdrop-blur-xl p-5 rounded-2xl bubble-glow relative',
      decorator: '',
      tag: '',
      avatar: randomAvatar
    },
    {
      containerClass: 'bg-white/95 dark:bg-slate-900/90 backdrop-blur-xl p-6 rounded-2xl bubble-glow relative',
      decorator: '',
      tag: `<div class="mt-3 flex items-center gap-2"><div class="px-2 py-1 bg-blue-50 dark:bg-blue-900/20 rounded-full text-xs font-bold text-blue-600 dark:text-blue-300">#LGY</div><div class="px-2 py-1 bg-purple-50 dark:bg-purple-900/20 rounded-full text-xs font-bold text-purple-600 dark:text-purple-300">#WMY</div></div>`,
      avatar: randomAvatar
    }
  ];
  return styleList[Math.floor(Math.random() * styleList.length)];
}

// ========== é¡µé¢å…ƒç´ ç»‘å®š ==========
const nicknameInput = document.getElementById("nickname-input");
const messageInput = document.getElementById("message-input");
const imageUpload = document.getElementById("imageUpload");
const imagePreview = document.getElementById("imagePreview");
const previewImg = document.getElementById("previewImg");
const uploadText = document.getElementById("uploadText");
const wishList = document.getElementById("wishList");
const successToast = document.getElementById('successToast');
const form = document.getElementById("wishForm");
const deleteConfirm = document.getElementById("deleteConfirm");
const cancelDelete = document.getElementById("cancelDelete");
const confirmDelete = document.getElementById("confirmDelete");

let currentDeleteId = null;
let selectedFile = null; // å­˜å‚¨é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶

// ========== å›¾ç‰‡ä¸Šä¼ ä¸é¢„è§ˆ ==========
imageUpload.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  // åªå…è®¸å›¾ç‰‡
  if (!file.type.startsWith('image/')) {
    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
    return;
  }
  
  selectedFile = file;
  uploadText.textContent = file.name;
  
  // é¢„è§ˆ
  const reader = new FileReader();
  reader.onload = (ev) => {
    previewImg.src = ev.target.result;
    imagePreview.classList.remove('hidden');
  };
  reader.readAsDataURL(file);
});

// ========== ä¸Šä¼ å›¾ç‰‡åˆ° Supabase Storage ==========
async function uploadImage(file) {
  if (!file) return null;
  
  try {
    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼Œé¿å…è¦†ç›–
    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 15)}.${fileExt}`;
    
    // ä¸Šä¼ åˆ° Storageï¼ˆå°å†™æ¡¶åï¼Œå’Œä½ çš„æ¡¶åä¿æŒä¸€è‡´ï¼‰
    const { data, error } = await supabaseClient
      .storage
      .from('wish-images')
      .upload(fileName, file, {
        cacheControl: '3600',
        upsert: false
      });
    
    if (error) {
      console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
      throw error;
    }
    
    // è·å–å…¬å¼€è®¿é—® URL
    const { data: { publicUrl } } = supabaseClient
      .storage
      .from('wish-images')
      .getPublicUrl(data.path);
    
    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼ŒURL:', publicUrl);
    return publicUrl;
  } catch (err) {
    alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + err.message);
    return null;
  }
}

// ========== ç”Ÿæˆç”¨æˆ·å”¯ä¸€ ID ==========
function generateUniqueId() {
  let id = localStorage.getItem('wishwall_user_id');
  if (!id) {
    id = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    localStorage.setItem('wishwall_user_id', id);
  }
  return id;
}

// ========== åŠ è½½å¯„è¯­åˆ—è¡¨ ==========
window.onload = loadWishes;

async function loadWishes() {
  try {
    const { data, error } = await supabaseClient
      .from("photo_submit")
      .select("*")
      .order("created_at", { ascending: false });

    if (error || !data || data.length === 0) {
      wishList.innerHTML = `<p class="text-primary/60 text-center py-8">æš‚æ— å¯„è¯­ï¼Œå¿«æ¥å†™ç¬¬ä¸€æ¡å§ï½</p>`;
      return;
    }

    const currentUserId = generateUniqueId();

    // æ ¸å¿ƒä¿®å¤ï¼šmapå¾ªç¯åå¿…é¡»join('')ï¼Œé¿å…DOMå‡ºç°é€—å·
    wishList.innerHTML = data.map(item => {
      const timeStr = new Date(item.created_at).toLocaleString();
      const isOwnWish = item.user_id === currentUserId;
      const randomStyle = getRandomCardStyle();
      
      // ========== å…³é”®ä¿®å¤1ï¼šç®€åŒ–å›¾ç‰‡æ¸²æŸ“æ¡ä»¶ ==========
      // åªè¦æœ‰photo_urlå°±æ¸²æŸ“ï¼Œä¸åštrimåˆ¤æ–­ï¼Œå»æ‰onerroréšè—é€»è¾‘
      const imageHtml = item.photo_url 
  ? `<div class="wish-image-container">
       <img 
         src="${item.photo_url}" 
         class="wish-image" 
         alt="ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡"
         onerror="this.src='https://via.placeholder.com/400x200?text=å›¾ç‰‡åŠ è½½å¤±è´¥'"
       />
     </div>`
  : '';
      
      return `
      <div class="masonry-item">
        <div class="kawaii-card ${randomStyle.containerClass} group">
          ${isOwnWish ? `
            <button class="delete-btn" data-id="${item.id}">
              <span class="material-icons text-sm">delete</span>
            </button>
          ` : ''}
          ${randomStyle.decorator}

          <div class="flex items-center gap-3 mb-3">
            <div class="relative">
              <img alt="profile" class="w-10 h-10 rounded-full border-3 border-purple-100 shadow-sm object-cover" src="${randomStyle.avatar}">
              <div class="absolute -bottom-1 -right-1 text-xs">âœ¨</div>
            </div>
            <div>
              <p class="font-bold text-sm text-primary dark:text-purple-300">${item.nickname || 'åŒ¿åç”¨æˆ·'}</p>
              <p class="text-xs opacity-60">${timeStr}</p>
            </div>
          </div>
          
          ${imageHtml} <!-- å›¾ç‰‡æ¸²æŸ“ -->
          
          <!-- æ ¸å¿ƒä¿®å¤ï¼šå­—æ®µåæ­£ç¡®æ˜ å°„ï¼Œæ˜¾ç¤ºç”¨æˆ·è¾“å…¥çš„å¯„è¯­ -->
          <p class="text-sm text-gray-700 dark:text-white/80 leading-relaxed mt-2">${item.mark_tag || ''}</p>
          ${randomStyle.tag}
        </div>
      </div>
      `;
    }).join(""); // å…³é”®ä¿®å¤ï¼šå¿…é¡»åŠ join('')

    // ç»‘å®šåˆ é™¤äº‹ä»¶
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        currentDeleteId = e.currentTarget.dataset.id;
        deleteConfirm.classList.remove('hidden');
      });
    });

  } catch (err) {
    console.error("åŠ è½½å¯„è¯­å¤±è´¥ï¼š", err);
    wishList.innerHTML = `<p class="text-primary/60 text-center">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>`;
  }
}

// ========== æäº¤è¡¨å•ï¼ˆå«å›¾ç‰‡ä¸Šä¼ ï¼‰ ==========
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const nick = nicknameInput?.value.trim() || '';
  const msg = messageInput?.value.trim() || '';

  if (!nick || !msg) {
    alert("æ˜µç§°å’Œå¯„è¯­ä¸èƒ½ä¸ºç©ºå“¦ï½");
    return;
  }

  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn?.innerText || "Submit";
  if (submitBtn) submitBtn.innerText = "ä¸Šä¼ ä¸­...";

  try {
    const currentUserId = generateUniqueId();
    let photoUrl = null;

    // æœ‰å›¾ç‰‡å°±å…ˆä¸Šä¼ 
    if (selectedFile) {
      photoUrl = await uploadImage(selectedFile);
      // å…³é”®ä¿®å¤2ï¼šç¡®è®¤ä¸Šä¼ æˆåŠŸæ‰ç»§ç»­
      if (!photoUrl) {
        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
        return;
      }
    }

    // å†™å…¥æ•°æ®åº“
    const { error: insErr } = await supabaseClient.from("photo_submit").insert([{
      nickname: nick,
      mark_tag: msg,
      photo_url: photoUrl, // ä¿å­˜å›¾ç‰‡ URL
      user_id: currentUserId
    }]);
    
    if (insErr) throw insErr;

    // æˆåŠŸåé‡ç½®
    showSuccessToast();
    form.reset();
    selectedFile = null;
    imagePreview.classList.add('hidden');
    uploadText.textContent = "ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡";
    loadWishes();

  } catch (err) {
    console.error('æäº¤å¤±è´¥:', err);
    alert('æäº¤å¤±è´¥: ' + err.message);
  } finally {
    if (submitBtn) submitBtn.innerText = originalText;
  }
});

// ========== æç¤ºä¸åˆ é™¤ ==========
function showSuccessToast() {
  if (!successToast) return;
  successToast.style.opacity = '1';
  successToast.style.pointerEvents = 'auto';
  setTimeout(() => {
    successToast.style.opacity = '0';
    successToast.style.pointerEvents = 'none';
  }, 3000);
}

cancelDelete?.addEventListener('click', () => {
  deleteConfirm.classList.add('hidden');
  currentDeleteId = null;
});

confirmDelete?.addEventListener('click', async () => {
  if (!currentDeleteId) return;

  try {
    const { error } = await supabaseClient
      .from("photo_submit")
      .delete()
      .eq("id", currentDeleteId);

    if (error) throw error;

    deleteConfirm.classList.add('hidden');
    currentDeleteId = null;
    loadWishes();
  } catch (err) {
    console.error('åˆ é™¤å¤±è´¥:', err);
    alert('åˆ é™¤å¤±è´¥: ' + err.message);
  }
});
</script>
</body>
</html>